var I=Object.defineProperty;var L=(h,t,e)=>t in h?I(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var p=(h,t,e)=>L(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class C{constructor(t,e,i){this.width=t,this.height=e,this.direction=i,this.snake=[],this._init()}_init(){const t=Math.floor(this.width/2),e=Math.floor(this.height/2);this.snake.push({x:t,y:e})}move(t,e){const i=this.snake[0],s={x:i.x+t.x,y:i.y+t.y};this.snake.unshift(s);const n=s.x===e.x&&s.y===e.y;return n||this.snake.pop(),n}getSegments(){return this.snake}getHead(){return this.snake[0]}}class v{constructor(t,e,i){this.width=t,this.height=e,this.position=this._generatePosition(i)}_generatePosition(t){for(;;){const e=Math.floor(Math.random()*this.width),i=Math.floor(Math.random()*this.height);if(!t.some(s=>s.x===e&&s.y===i))return{x:e,y:i}}}getPosition(){return this.position}}const a=class a{static computeNewDirection(t,e){const i=a.DIRECTIONS.length;return((t+e-1)%i+i)%i}static getRelativeAction(t,e){const i=a.DIRECTIONS.length,s=(e-t+i)%i;return s===1?2:s===i-1?0:1}constructor(t,e){this.width=t,this.height=e,this.reset()}reset(){const t=Math.floor(Math.random()*a.DIRECTIONS.length);return this.snake=new C(this.width,this.height,t),this.food=new v(this.width,this.height,this.snake.getSegments()),this.frame=0,this.score=0,this.done=!1,this.getState()}step(t){if(this.done)return{nextState:this.getState(),reward:0,done:!0};const e=this.snake.getHead();this.snake.direction=a.computeNewDirection(this.snake.direction,t);const i=a.DIRECTIONS[this.snake.direction],s=this.snake.move(i,this.food.getPosition());s&&(this.score++,this.food=new v(this.width,this.height,this.snake.getSegments()));const n=this.snake.getHead();this.frame++;const o=this.frame>100*this.snake.getSegments().length,r=this._isCollision();(o||r)&&(this.done=!0);const c=this._getReward({prevHead:e,currHead:n,ate:s,collision:r,timeout:o});return{nextState:this.getState(),reward:c,done:this.done}}getState(){return[...this._getDirectionState(),...this._getFoodRelativeDirection(),...this._getSurroundingDanger()]}_getDirectionState(){return[this.snake.direction===0,this.snake.direction===1,this.snake.direction===2,this.snake.direction===3]}_getFoodRelativeDirection(){const t=Array(4).fill(!1),e=this.snake.getHead(),i=this.food.getPosition().x-e.x,s=this.food.getPosition().y-e.y;let[n,o]=[0,0];return this.snake.direction===0?[n,o]=[-s,-i]:this.snake.direction===1?[n,o]=[i,-s]:this.snake.direction===2?[n,o]=[s,i]:this.snake.direction===3&&([n,o]=[-i,s]),t[0]=n<0,t[1]=o>0,t[2]=n>0,t[3]=o<0,t}_getSurroundingDanger(){return[0,1,2].map(t=>{const e=a.computeNewDirection(this.snake.direction,t),i=a.DIRECTIONS[e],{x:s,y:n}=this.snake.getHead(),o={x:s+i.x,y:n+i.y};return this._isCollision({nextHead:o})})}_getReward({prevHead:t,currHead:e,ate:i,collision:s,timeout:n}){if(n||s)return-10;if(i)return 10;const o=Math.abs(this.food.getPosition().x-t.x)+Math.abs(this.food.getPosition().y-t.y),r=Math.abs(this.food.getPosition().x-e.x)+Math.abs(this.food.getPosition().y-e.y);return 1*(o-r)+-1}_isCollision({nextHead:t=null}={}){const e=t??this.snake.getHead(),{x:i,y:s}=e,n=i<0||i>=this.width||s<0||s>=this.height,o=this.snake.getSegments().slice(1).some(r=>r.x===i&&r.y===s);return n||o}isDone(){return this.done}getScore(){return this.score}getElapsedTime(){return this.frame}getDirection(){return this.snake.direction}};p(a,"DIRECTIONS",[{x:-1,y:0},{x:0,y:-1},{x:1,y:0},{x:0,y:1}]);let y=a;class w{constructor(t,e,i,{containerId:s="board",gap:n=0}={}){this.width=t,this.height=e,this.cellSize=i,this.container=document.getElementById(s),this.gap=n,this.cells=[],this._init()}_init(){this.container.innerHTML="",this.container.style.display="grid",this.container.style.gridTemplateColumns=`repeat(${this.width}, ${this.cellSize}px)`,this.container.style.gridTemplateRows=`repeat(${this.height}, ${this.cellSize}px)`,this.container.style.gap=`${this.gap}px`;for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++){const i=document.createElement("div");i.classList.add("cell"),i.style.width=`${this.cellSize}px`,i.style.height=`${this.cellSize}px`,this.container.appendChild(i),this.cells.push(i)}}getCell(t,e){return t<0||t>=this.width||e<0||e>=this.height?null:this.cells[t+e*this.width]}clear(){for(const t of this.cells)t.className="cell"}render(t,e){this.clear();for(let s=0;s<t.length;s++){const{x:n,y:o}=t[s],r=this.getCell(n,o);r&&(s===0?r.classList.add("head"):r.classList.add("snake"))}const i=this.getCell(e.x,e.y);i&&i.classList.add("food")}}class _{constructor(){this.highScoreValue=document.getElementById("high-score-value"),this.scoreValue=document.getElementById("score-value"),this.episode=document.getElementById("episode"),this.episodeValue=document.getElementById("episode-value")}updateScore(t){this.scoreValue.textContent=t}updateHighestScore(t){this.highScoreValue.textContent=t}updateEpisode(t){this.episodeValue.textContent=t}showEpisode(){this.episode.style.display=""}hideEpisode(){this.episode.style.display="none"}}class M{constructor(t){p(this,"_keydownControl",t=>{const e=["Tab","Escape","Alt","Control","Shift","Meta"],i=document.activeElement.tagName==="INPUT";this.overlay.style.display!=="none"&&this.overlayScore.style.display==="none"&&!i&&!e.includes(t.key)&&this._onStart()});this.overlay=document.getElementById("overlay"),this.overlayTitle=document.getElementById("overlay-title"),this.overlayScore=document.getElementById("overlay-score"),this.overlayInstruction=document.getElementById("overlay-instruction"),this._onStart=t,document.addEventListener("keydown",this._keydownControl)}show(){this.overlay.style.display="flex"}hide(){this.overlay.style.display="none"}showStart(){this.overlayScore.style.display="none",this.overlayInstruction.style.display="none",this._setText("Press any key to start"),this.overlayTitle.style.fontSize="2.5rem",this.show()}showGameOver(t){this._setText("Game Over"),this.overlayTitle.style.fontSize="3rem",this.overlayScore.textContent=`Score: ${t}`,this.overlayInstruction.textContent="Press any key to reset",this.overlayScore.style.display="block",this.overlayInstruction.style.display="block",this.show()}_setText(t){this.overlayTitle.textContent=t}removeEvent(){document.removeEventListener("keydown",this._keydownControl),this.overlay.style.display="none",this._onStart=null}}class b{constructor({width:t,height:e,cellSize:i,onSizeChange:s,minValue:n=5,maxValue:o=100}){this.onSizeChange=s,this.minValue=n,this.maxValue=o,this.inputs={width:document.getElementById("input-width"),height:document.getElementById("input-height"),cellSize:document.getElementById("input-cell")},this.inputs.width.value=t,this.inputs.height.value=e,this.inputs.cellSize.value=i,this._initListeners()}_initListeners(){for(const[t,e]of Object.entries(this.inputs))e.addEventListener("input",i=>{const s=parseInt(i.target.value,10);!isNaN(s)&&s>=this.minValue&&s<=this.maxValue&&this.onSizeChange(t,s)}),e.addEventListener("keydown",i=>{(i.key==="Enter"||i.key==="Escape")&&(i.stopPropagation(),e.blur())})}removeEvent(){for(const t of Object.values(this.inputs))t.replaceWith(t.cloneNode(!0));this.inputs=null,this.onSizeChange=null}}class k{constructor({width:t=40,height:e=20,cellSize:i=20,manual:s=!1}={}){this.width=t,this.height=e,this.cellSize=i,this.manual=s,this.highestScore=0,this.board=new w(this.width,this.height,this.cellSize),this.game=new y(this.width,this.height),this.hud=new _,this.overlay=this.manual?new M(this.start.bind(this)):null,this.inputPanel=new b({width:this.width,height:this.height,cellSize:this.cellSize,onSizeChange:this._handleSizeChange.bind(this)}),this.intervalId=null,this.action=1,this._handleKeydown=this._handleKeydown.bind(this),this.setControlMode(this.manual)}_init(){var t;(t=this.overlay)==null||t.showStart(),this.render()}setControlMode(t){this.manual=t,this.manual?this.hud.hideEpisode():this.hud.showEpisode(),this._init()}start(){var t;this.intervalId&&clearInterval(this.intervalId),(t=this.overlay)==null||t.hide(),this.intervalId=setInterval(()=>{if(this.game.step(this.action),this.game.isDone()){clearInterval(this.intervalId),this.intervalId=null,this._handleGameOver();return}this.render(),this.action=1},100)}step(t){const e=this.game.step(t);return this.render(),e}render(){const t=this.game.snake,e=this.game.food;this.board.render(t.getSegments(),e.getPosition()),this.hud.updateScore(this.game.getScore())}getState(){return this.game.getState()}updateEpisode(t){this.hud.updateEpisode(t)}restartRound(){this.highestScore=Math.max(this.highestScore,this.game.getScore()),this.hud.updateHighestScore(this.highestScore),this.game.reset(),this._init()}_rebuildGame(){this.board=new w(this.width,this.height,this.cellSize),this.game=new y(this.width,this.height),this._init()}_handleSizeChange(t,e){t==="width"?this.width=e:t==="height"?this.height=e:t==="cellSize"&&(this.cellSize=e),this._rebuildGame()}attachKeydownListener(){document.addEventListener("keydown",this._handleKeydown)}_handleKeydown(t){function e(s){return["Tab","Alt","Meta","Control","Shift"].includes(s)||s.startsWith("Arrow")}this.intervalId&&e(t.key)&&t.preventDefault();const i={ArrowLeft:0,ArrowUp:1,ArrowRight:2,ArrowDown:3};if(t.key in i){const s=this.game.getDirection();this.action=y.getRelativeAction(s,i[t.key])}}_handleGameOver(){var e;(e=this.overlay)==null||e.showGameOver(this.game.getScore());const t=i=>{["Tab","Alt","Meta","Control","Shift"].includes(i.key)||(i.stopPropagation(),i.preventDefault(),document.removeEventListener("keydown",t),this.restartRound())};document.addEventListener("keydown",t)}removeEvent(){var t,e;this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),(t=this.overlay)==null||t.removeEvent(),(e=this.inputPanel)==null||e.removeEvent()}}function D(){const h=new k({manual:!0});return h.attachKeydownListener(),{game:h,destroy:()=>{var t;(t=h.removeEvent)==null||t.call(h)}}}const g=[0,1,2];class T{constructor(t=.1,e=.9,i=1,s=0,n=.995){this.alpha=t,this.gamma=e,this.epsilon=i,this.minEpsilon=s,this.epsilonDecay=n,this.qTable=new Map}getQ(t,e){const i=JSON.stringify([...t,e]),s=this.qTable.get(i);return s||0}updateQ(t,e,i,s){const n=JSON.stringify([...t,e]),o=this.getQ(t,e),r=Math.max(...g.map(u=>this.getQ(s,u))),c=(1-this.alpha)*o+this.alpha*(i+this.gamma*r);this.qTable.set(n,c)}chooseAction(t){if(Math.random()<this.epsilon)return g[Math.floor(Math.random()*g.length)];{const e=g.map(n=>this.getQ(t,n)),i=Math.max(...e),s=g.filter(n=>e[n]===i);return s[Math.floor(Math.random()*s.length)]}}decayEpsilon(){this.epsilon=Math.max(this.minEpsilon,this.epsilon*this.epsilonDecay)}}function O(){let e=10;const i=new k,s=new T,n=5e3;let o=0,r=!1;function c(d){d.keyCode===32&&(e=e===0?10:0)}async function u(){if(o>=n||r){console.log("Training complete!");return}let d=i.getState();for(;!i.game.isDone()&&!r;){const m=s.chooseAction(d),{nextState:f,reward:E}=i.step(m);s.updateQ(d,m,E,f),d=f,e===10||o%100===0?await new Promise(x=>setTimeout(x,e)):await Promise.resolve()}r||(console.log(`Episode ${o+1}: Epsilon: ${s.epsilon.toFixed(4)}, Score: ${i.game.getScore()}`),s.decayEpsilon(),i.restartRound(),i.updateEpisode(++o),u())}return document.addEventListener("keydown",c),{game:i,start:()=>{o=0,r=!1,u()},destroy:()=>{var d;r=!0,document.removeEventListener("keydown",c),(d=i.removeEvent)==null||d.call(i)}}}let l=null;function P(){l!=null&&l.destroy&&l.destroy(),l=null}function S(h){P(),l=h?O():D()}document.addEventListener("DOMContentLoaded",()=>{const h=document.getElementById("mode-toggle"),t=document.getElementById("start-training"),e=document.getElementById("start-hint");h.checked?(t.classList.remove("hidden"),e.classList.remove("hidden")):(t.classList.add("hidden"),e.classList.add("hidden")),h.addEventListener("change",()=>{h.checked?(t.classList.remove("hidden"),e.classList.remove("hidden")):(t.classList.add("hidden"),e.classList.add("hidden")),S(h.checked)}),t.addEventListener("click",()=>{h.checked&&(l!=null&&l.start)&&l.start()}),S(h.checked)});
