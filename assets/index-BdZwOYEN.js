var C=Object.defineProperty;var D=(h,t,e)=>t in h?C(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var I=(h,t,e)=>D(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class M{constructor({width:t,height:e,cellSize:i,onSizeChange:s,minValue:o=5,maxValue:n=100}){this.onSizeChange=s,this.minValue=o,this.maxValue=n,this.inputs={width:document.getElementById("input-width"),height:document.getElementById("input-height"),cellSize:document.getElementById("input-cell")},this.inputs.width.value=t,this.inputs.height.value=e,this.inputs.cellSize.value=i,this._initListeners()}_initListeners(){for(const[t,e]of Object.entries(this.inputs))e.addEventListener("input",i=>{const s=parseInt(i.target.value,10);!isNaN(s)&&s>=this.minValue&&s<=this.maxValue&&this.onSizeChange(t,s)}),e.addEventListener("keydown",i=>{(i.key==="Enter"||i.key==="Escape")&&(i.stopPropagation(),e.blur())})}removeEvent(){for(const t of Object.values(this.inputs))t.replaceWith(t.cloneNode(!0));this.inputs=null,this.onSizeChange=null}}function T(h){const t=document.getElementById("mode-toggle"),e=document.getElementById("start-training"),i=document.getElementById("stop-training"),s=document.getElementById("start-hint"),o=e.querySelector(".material-icons");let n=!1,r=!1;const l=[e,i],c=[e,i,s],f=[],m=[],d=[],v=[];function p(a){for(const y of a)y()}function w(a,y){for(const x of a)x.classList.toggle("hidden",!y)}function S(a){e.classList.toggle("start",!a),e.classList.toggle("pause",a),o.textContent=a?"pause":"play_arrow"}function g(a){i.disabled=!a,i.classList.toggle("enabled",a),i.classList.toggle("disabled",!a)}w(c,t.checked),h(t.checked),t.addEventListener("change",()=>{n=!1,r=!1,S(n),g(n),w(c,t.checked),h(t.checked)}),e.addEventListener("click",()=>{n=!n,S(n),g(!0),t.checked&&(r?p(n?d:m):(r=!0,p(f))),e.blur()}),i.addEventListener("click",()=>{n=!1,r=!1,S(n),g(n),p(v),i.blur()});for(const a of l)a.addEventListener("keydown",y=>{[" ","Enter"].includes(y.key)&&(y.stopPropagation(),a.blur())});return window.addEventListener("keydown",a=>{const y=document.activeElement.tagName.toLowerCase(),x=["input","textarea","button"].includes(y);[" ","Enter"].includes(a.key)&&!x&&a.preventDefault()}),{onStart:a=>f.push(a),onPause:a=>m.push(a),onResume:a=>d.push(a),onStop:a=>v.push(a)}}class P{constructor(t,e,i){this.width=t,this.height=e,this.direction=i,this.snake=[],this._init()}_init(){const t=Math.floor(this.width/2),e=Math.floor(this.height/2);this.snake.push({x:t,y:e})}move(t,e){const i=this.snake[0],s={x:i.x+t.x,y:i.y+t.y};this.snake.unshift(s);const o=s.x===e.x&&s.y===e.y;return o||this.snake.pop(),o}getSegments(){return this.snake}getHead(){return this.snake[0]}}class L{constructor(t,e,i){this.width=t,this.height=e,this.position=this._generatePosition(i)}_generatePosition(t){for(;;){const e=Math.floor(Math.random()*this.width),i=Math.floor(Math.random()*this.height);if(!t.some(s=>s.x===e&&s.y===i))return{x:e,y:i}}}getPosition(){return this.position}}const u=class u{static computeNewDirection(t,e){const i=u.DIRECTIONS.length;return((t+e-1)%i+i)%i}static getRelativeAction(t,e){const i=u.DIRECTIONS.length,s=(e-t+i)%i;return s===1?2:s===i-1?0:1}constructor(t,e){this.width=t,this.height=e,this.reset()}reset(){const t=Math.floor(Math.random()*u.DIRECTIONS.length);return this.snake=new P(this.width,this.height,t),this.food=new L(this.width,this.height,this.snake.getSegments()),this.frame=0,this.score=0,this.done=!1,this.getState()}step(t){if(this.done)return{nextState:this.getState(),reward:0,done:!0};const e=this.snake.getHead();this.snake.direction=u.computeNewDirection(this.snake.direction,t);const i=u.DIRECTIONS[this.snake.direction],s=this.snake.move(i,this.food.getPosition());s&&(this.score++,this.food=new L(this.width,this.height,this.snake.getSegments()));const o=this.snake.getHead();this.frame++;const n=this.frame>100*this.snake.getSegments().length,r=this._isCollision();(n||r)&&(this.done=!0);const l=this._getReward({prevHead:e,currHead:o,ate:s,collision:r,timeout:n});return{nextState:this.getState(),reward:l,done:this.done}}getState(){return[...this._getDirectionState(),...this._getFoodRelativeDirection(),...this._getSurroundingDanger()]}_getDirectionState(){return[this.snake.direction===0,this.snake.direction===1,this.snake.direction===2,this.snake.direction===3]}_getFoodRelativeDirection(){const t=Array(4).fill(!1),e=this.snake.getHead(),i=this.food.getPosition().x-e.x,s=this.food.getPosition().y-e.y;let[o,n]=[0,0];return this.snake.direction===0?[o,n]=[-s,-i]:this.snake.direction===1?[o,n]=[i,-s]:this.snake.direction===2?[o,n]=[s,i]:this.snake.direction===3&&([o,n]=[-i,s]),t[0]=o<0,t[1]=n>0,t[2]=o>0,t[3]=n<0,t}_getSurroundingDanger(){return[0,1,2].map(t=>{const e=u.computeNewDirection(this.snake.direction,t),i=u.DIRECTIONS[e],{x:s,y:o}=this.snake.getHead(),n={x:s+i.x,y:o+i.y};return this._isCollision({nextHead:n})})}_getReward({prevHead:t,currHead:e,ate:i,collision:s,timeout:o}){if(o||s)return-10;if(i)return 10;const n=Math.abs(this.food.getPosition().x-t.x)+Math.abs(this.food.getPosition().y-t.y),r=Math.abs(this.food.getPosition().x-e.x)+Math.abs(this.food.getPosition().y-e.y);return 1*(n-r)+-1}_isCollision({nextHead:t=null}={}){const e=t??this.snake.getHead(),{x:i,y:s}=e,o=i<0||i>=this.width||s<0||s>=this.height,n=this.snake.getSegments().slice(1).some(r=>r.x===i&&r.y===s);return o||n}isDone(){return this.done}getScore(){return this.score}getElapsedTime(){return this.frame}getDirection(){return this.snake.direction}};I(u,"DIRECTIONS",[{x:-1,y:0},{x:0,y:-1},{x:1,y:0},{x:0,y:1}]);let k=u;class _{constructor(t,e,i,{containerId:s="board",gap:o=0}={}){this.width=t,this.height=e,this.cellSize=i,this.container=document.getElementById(s),this.gap=o,this.cells=[],this._init()}_init(){this.container.innerHTML="",this.container.style.display="grid",this.container.style.gridTemplateColumns=`repeat(${this.width}, ${this.cellSize}px)`,this.container.style.gridTemplateRows=`repeat(${this.height}, ${this.cellSize}px)`,this.container.style.gap=`${this.gap}px`;for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++){const i=document.createElement("div");i.classList.add("cell"),i.style.width=`${this.cellSize}px`,i.style.height=`${this.cellSize}px`,this.container.appendChild(i),this.cells.push(i)}}getCell(t,e){return t<0||t>=this.width||e<0||e>=this.height?null:this.cells[t+e*this.width]}clear(){for(const t of this.cells)t.className="cell"}render(t,e){this.clear();for(let s=0;s<t.length;s++){const{x:o,y:n}=t[s],r=this.getCell(o,n);r&&(s===0?r.classList.add("head"):r.classList.add("snake"))}const i=this.getCell(e.x,e.y);i&&i.classList.add("food")}}class O{constructor(){this.highScoreValue=document.getElementById("high-score-value"),this.scoreValue=document.getElementById("score-value"),this.episode=document.getElementById("episode"),this.episodeValue=document.getElementById("episode-value")}updateScore(t){this.scoreValue.textContent=t}updateHighestScore(t){this.highScoreValue.textContent=t}updateEpisode(t){this.episodeValue.textContent=t}showEpisode(){this.episode.style.display=""}hideEpisode(){this.episode.style.display="none"}}class B{constructor(t){I(this,"_keydownControl",t=>{const e=["Tab","Escape","Alt","Control","Shift","Meta"],i=document.activeElement.tagName==="INPUT";this.overlay.style.display!=="none"&&this.overlayScore.style.display==="none"&&!i&&!e.includes(t.key)&&this._onStart()});this.overlay=document.getElementById("overlay"),this.overlayTitle=document.getElementById("overlay-title"),this.overlayScore=document.getElementById("overlay-score"),this.overlayInstruction=document.getElementById("overlay-instruction"),this._onStart=t,document.addEventListener("keydown",this._keydownControl)}show(){this.overlay.style.display="flex"}hide(){this.overlay.style.display="none"}showStart(){this.overlayScore.style.display="none",this.overlayInstruction.style.display="none",this._setText("Press any key to start"),this.overlayTitle.style.fontSize="2.5rem",this.show()}showGameOver(t){this._setText("Game Over"),this.overlayTitle.style.fontSize="3rem",this.overlayScore.textContent=`Score: ${t}`,this.overlayInstruction.textContent="Press any key to reset",this.overlayScore.style.display="block",this.overlayInstruction.style.display="block",this.show()}_setText(t){this.overlayTitle.textContent=t}removeEvent(){document.removeEventListener("keydown",this._keydownControl),this.overlay.style.display="none",this._onStart=null}}class b{constructor({width:t=40,height:e=20,cellSize:i=20,manual:s=!1}={}){this.width=t,this.height=e,this.cellSize=i,this.manual=s,this.highestScore=0,this.board=new _(this.width,this.height,this.cellSize),this.game=new k(this.width,this.height),this.hud=new O,this.overlay=this.manual?new B(this.start.bind(this)):null,this.intervalId=null,this.action=1,this._handleKeydown=this._handleKeydown.bind(this),this.setControlMode(this.manual)}_init(){var t;(t=this.overlay)==null||t.showStart(),this.render()}setControlMode(t){this.manual=t,this.manual?this.hud.hideEpisode():this.hud.showEpisode(),this._init()}start(){var t;this.intervalId&&clearInterval(this.intervalId),(t=this.overlay)==null||t.hide(),this.intervalId=setInterval(()=>{if(this.game.step(this.action),this.game.isDone()){clearInterval(this.intervalId),this.intervalId=null,this._handleGameOver();return}this.render(),this.action=1},100)}step(t){const e=this.game.step(t);return this.render(),e}render(){const t=this.game.snake,e=this.game.food;this.board.render(t.getSegments(),e.getPosition()),this.hud.updateScore(this.game.getScore())}getState(){return this.game.getState()}updateEpisode(t){this.hud.updateEpisode(t)}restartRound(){this.highestScore=Math.max(this.highestScore,this.game.getScore()),this.hud.updateHighestScore(this.highestScore),this.game.reset(),this._init()}attachKeydownListener(){document.addEventListener("keydown",this._handleKeydown)}_handleKeydown(t){function e(s){return["Tab","Alt","Meta","Control","Shift"].includes(s)||s.startsWith("Arrow")}this.intervalId&&e(t.key)&&t.preventDefault();const i={ArrowLeft:0,ArrowUp:1,ArrowRight:2,ArrowDown:3};if(t.key in i){const s=this.game.getDirection();this.action=k.getRelativeAction(s,i[t.key])}}_handleGameOver(){var e;(e=this.overlay)==null||e.showGameOver(this.game.getScore());const t=i=>{["Tab","Alt","Meta","Control","Shift"].includes(i.key)||(i.stopPropagation(),i.preventDefault(),document.removeEventListener("keydown",t),this.restartRound())};document.addEventListener("keydown",t)}removeEvent(){var t,e;this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),(t=this.overlay)==null||t.removeEvent(),(e=this.inputPanel)==null||e.removeEvent()}}function N(h){const t=new b({...h,manual:!0});return t.attachKeydownListener(),{game:t,destroy:()=>{var e;(e=t.removeEvent)==null||e.call(t)}}}const E=[0,1,2];class R{constructor(t=.1,e=.9,i=1,s=0,o=.995){this.alpha=t,this.gamma=e,this.epsilon=i,this.minEpsilon=s,this.epsilonDecay=o,this.qTable=new Map}getQ(t,e){const i=JSON.stringify([...t,e]),s=this.qTable.get(i);return s||0}updateQ(t,e,i,s){const o=JSON.stringify([...t,e]),n=this.getQ(t,e),r=Math.max(...E.map(c=>this.getQ(s,c))),l=(1-this.alpha)*n+this.alpha*(i+this.gamma*r);this.qTable.set(o,l)}chooseAction(t){if(Math.random()<this.epsilon)return E[Math.floor(Math.random()*E.length)];{const e=E.map(o=>this.getQ(t,o)),i=Math.max(...e),s=E.filter(o=>e[o]===i);return s[Math.floor(Math.random()*s.length)]}}decayEpsilon(){this.epsilon=Math.max(this.minEpsilon,this.epsilon*this.epsilonDecay)}}function z(h){let i=1;const s=new b(h),o=new R,n=5e3;let r=0,l=!1,c=!1;function f(d){d.keyCode===32&&(i=i===0?1:0)}async function m(){if(r>=n||l){console.log("Training complete!");return}let d=s.getState(),v=0;for(;!s.game.isDone()&&!l;){c&&await new Promise(g=>{const a=()=>{c||(document.removeEventListener("resume-training",a),g())};document.addEventListener("resume-training",a)});const p=o.chooseAction(d),{nextState:w,reward:S}=s.step(p);o.updateQ(d,p,S,w),d=w,i===1?await new Promise(g=>setTimeout(g,i)):++v%200===0?await new Promise(g=>setTimeout(g,i)):await Promise.resolve()}l||(o.decayEpsilon(),s.restartRound(),s.updateEpisode(++r),m())}return document.addEventListener("keydown",f),{game:s,start:()=>{r=0,l=!1,c=!1,m()},pause:()=>{c=!0},resume:()=>{c&&(c=!1,document.dispatchEvent(new Event("resume-training")))},stop:()=>{i=1,l=!0,c=!1,s.updateEpisode(r),console.log("Training stopped.")},destroy:()=>{var d;l=!0,document.removeEventListener("keydown",f),(d=s.removeEvent)==null||d.call(s)}}}function A(){const h={width:40,height:20,cellSize:20};let t=null,e=!1;new M({...h,onSizeChange:i});function i(n,r){n==="width"?h.width=r:n==="height"?h.height=r:n==="cellSize"&&(h.cellSize=r),s(e)}function s(n){var r;e=n,(r=t==null?void 0:t.destroy)==null||r.call(t),t=n?z():N()}const o=T(s);o.onStart(()=>{var n;return(n=t==null?void 0:t.start)==null?void 0:n.call(t)}),o.onPause(()=>{var n;return(n=t==null?void 0:t.pause)==null?void 0:n.call(t)}),o.onResume(()=>{var n;return(n=t==null?void 0:t.resume)==null?void 0:n.call(t)}),o.onStop(()=>{var n;return(n=t==null?void 0:t.stop)==null?void 0:n.call(t)})}document.body.style.visibility="hidden";window.addEventListener("load",()=>{document.body.style.visibility="visible"});A();
