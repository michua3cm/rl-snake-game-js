var O=Object.defineProperty;var B=(r,t,s)=>t in r?O(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s;var _=(r,t,s)=>B(r,typeof t!="symbol"?t+"":t,s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))i(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function s(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(e){if(e.ep)return;e.ep=!0;const n=s(e);fetch(e.href,n)}})();class N{constructor({width:t,height:s,cellSize:i,onSizeChange:e,minValue:n=5,maxValue:o=100}){this.onSizeChange=e,this.minValue=n,this.maxValue=o,this.inputs={width:document.getElementById("input-width"),height:document.getElementById("input-height"),cellSize:document.getElementById("input-cell")},this.inputs.width.value=t,this.inputs.height.value=s,this.inputs.cellSize.value=i,this._initListeners()}_initListeners(){for(const[t,s]of Object.entries(this.inputs))s.addEventListener("input",i=>{const e=parseInt(i.target.value,10);!isNaN(e)&&e>=this.minValue&&e<=this.maxValue&&this.onSizeChange(t,e)}),s.addEventListener("keydown",i=>{(i.key==="Enter"||i.key==="Escape")&&(i.stopPropagation(),s.blur())})}removeEvent(){for(const t of Object.values(this.inputs))t.replaceWith(t.cloneNode(!0));this.inputs=null,this.onSizeChange=null}}function R(r){const t=document.getElementById("mode-toggle"),s=document.getElementById("start-training"),i=document.getElementById("stop-training"),e=document.getElementById("speed"),n=document.getElementById("start-hint"),o=s.querySelector(".material-icons"),l=e.querySelector(".material-icons");let h=!1,d=!1,y=!1;const m=[s,i,e],u=[...m,n],w=[],v=[],S=[],L=[],p=[],E=[];function f(a){for(const c of a)c()}function T(a,c){for(const D of a)D.classList.toggle("hidden",!c)}function b(a){s.classList.toggle("start",!a),s.classList.toggle("pause",a),o.textContent=a?"pause":"play_arrow"}function C(a){i.disabled=!a,i.classList.toggle("enabled",a),i.classList.toggle("disabled",!a)}function x(a,c){e.disabled=!a,e.classList.toggle("enabled",a),e.classList.toggle("disabled",!a),e.classList.toggle("fast",c),e.classList.toggle("slow",!c),l.textContent=c?"keyboard_arrow_right":"keyboard_double_arrow_right"}T(u,t.checked),r(t.checked),t.addEventListener("change",()=>{h=!1,y=!1,d=!1,b(h),C(h),x(h,d),T(u,t.checked),r(t.checked)}),s.addEventListener("click",()=>{h=!h,b(h),C(!0),x(!0,!1),t.checked&&(y?f(h?S:v):(y=!0,f(w))),s.blur()}),i.addEventListener("click",()=>{h=!1,y=!1,d=!1,b(h),C(h),x(h,d),f(L),i.blur()}),e.addEventListener("click",()=>{d=!d,x(h,d),f(d?p:E),e.blur()});for(const a of m)a.addEventListener("keydown",c=>{[" ","Enter"].includes(c.key)&&(c.stopPropagation(),a.blur())});return window.addEventListener("keydown",a=>{const c=document.activeElement.tagName.toLowerCase(),D=["input","textarea","button"].includes(c);[" ","Enter"].includes(a.key)&&!D&&a.preventDefault()}),{onStart:a=>w.push(a),onPause:a=>v.push(a),onResume:a=>S.push(a),onStop:a=>L.push(a),onSpeedUp:a=>p.push(a),onSlowDown:a=>E.push(a)}}class A{constructor(t,s,i){this.width=t,this.height=s,this.direction=i,this.snake=[],this._init()}_init(){const t=Math.floor(this.width/2),s=Math.floor(this.height/2);this.snake.push({x:t,y:s})}move(t,s){const i=this.snake[0],e={x:i.x+t.x,y:i.y+t.y};this.snake.unshift(e);const n=e.x===s.x&&e.y===s.y;return n||this.snake.pop(),n}getSegments(){return this.snake}getHead(){return this.snake[0]}}class M{constructor(t,s,i){this.width=t,this.height=s,this.position=this._generatePosition(i)}_generatePosition(t){for(;;){const s=Math.floor(Math.random()*this.width),i=Math.floor(Math.random()*this.height);if(!t.some(e=>e.x===s&&e.y===i))return{x:s,y:i}}}getPosition(){return this.position}}const g=class g{static computeNewDirection(t,s){const i=g.DIRECTIONS.length;return((t+s-1)%i+i)%i}static getRelativeAction(t,s){const i=g.DIRECTIONS.length,e=(s-t+i)%i;return e===1?2:e===i-1?0:1}constructor(t,s){this.width=t,this.height=s,this.reset()}reset(){const t=Math.floor(Math.random()*g.DIRECTIONS.length);return this.snake=new A(this.width,this.height,t),this.food=new M(this.width,this.height,this.snake.getSegments()),this.frame=0,this.score=0,this.done=!1,this.getState()}step(t){if(this.done)return{nextState:this.getState(),reward:0,done:!0};const s=this.snake.getHead();this.snake.direction=g.computeNewDirection(this.snake.direction,t);const i=g.DIRECTIONS[this.snake.direction],e=this.snake.move(i,this.food.getPosition());e&&(this.score++,this.food=new M(this.width,this.height,this.snake.getSegments()));const n=this.snake.getHead();this.frame++;const o=this.frame>100*this.snake.getSegments().length,l=this._isCollision();(o||l)&&(this.done=!0);const h=this._getReward({prevHead:s,currHead:n,ate:e,collision:l,timeout:o});return{nextState:this.getState(),reward:h,done:this.done}}getState(){return[...this._getDirectionState(),...this._getFoodRelativeDirection(),...this._getSurroundingDanger()]}_getDirectionState(){return[this.snake.direction===0,this.snake.direction===1,this.snake.direction===2,this.snake.direction===3]}_getFoodRelativeDirection(){const t=Array(4).fill(!1),s=this.snake.getHead(),i=this.food.getPosition().x-s.x,e=this.food.getPosition().y-s.y;let[n,o]=[0,0];return this.snake.direction===0?[n,o]=[-e,-i]:this.snake.direction===1?[n,o]=[i,-e]:this.snake.direction===2?[n,o]=[e,i]:this.snake.direction===3&&([n,o]=[-i,e]),t[0]=n<0,t[1]=o>0,t[2]=n>0,t[3]=o<0,t}_getSurroundingDanger(){return[0,1,2].map(t=>{const s=g.computeNewDirection(this.snake.direction,t),i=g.DIRECTIONS[s],{x:e,y:n}=this.snake.getHead(),o={x:e+i.x,y:n+i.y};return this._isCollision({nextHead:o})})}_getReward({prevHead:t,currHead:s,ate:i,collision:e,timeout:n}){if(n||e)return-10;if(i)return 10;const o=Math.abs(this.food.getPosition().x-t.x)+Math.abs(this.food.getPosition().y-t.y),l=Math.abs(this.food.getPosition().x-s.x)+Math.abs(this.food.getPosition().y-s.y);return 1*(o-l)+-1}_isCollision({nextHead:t=null}={}){const s=t??this.snake.getHead(),{x:i,y:e}=s,n=i<0||i>=this.width||e<0||e>=this.height,o=this.snake.getSegments().slice(1).some(l=>l.x===i&&l.y===e);return n||o}isDone(){return this.done}getScore(){return this.score}getElapsedTime(){return this.frame}getDirection(){return this.snake.direction}};_(g,"DIRECTIONS",[{x:-1,y:0},{x:0,y:-1},{x:1,y:0},{x:0,y:1}]);let I=g;class z{constructor(t,s,i,{containerId:e="board",gap:n=0}={}){this.width=t,this.height=s,this.cellSize=i,this.container=document.getElementById(e),this.gap=n,this.cells=[],this._init()}_init(){this.container.innerHTML="",this.container.style.display="grid",this.container.style.gridTemplateColumns=`repeat(${this.width}, ${this.cellSize}px)`,this.container.style.gridTemplateRows=`repeat(${this.height}, ${this.cellSize}px)`,this.container.style.gap=`${this.gap}px`;for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++){const i=document.createElement("div");i.classList.add("cell"),i.style.width=`${this.cellSize}px`,i.style.height=`${this.cellSize}px`,this.container.appendChild(i),this.cells.push(i)}}getCell(t,s){return t<0||t>=this.width||s<0||s>=this.height?null:this.cells[t+s*this.width]}clear(){for(const t of this.cells)t.className="cell"}render(t,s){this.clear();for(let e=0;e<t.length;e++){const{x:n,y:o}=t[e],l=this.getCell(n,o);l&&(e===0?l.classList.add("head"):l.classList.add("snake"))}const i=this.getCell(s.x,s.y);i&&i.classList.add("food")}}class V{constructor(){this.highScoreValue=document.getElementById("high-score-value"),this.scoreValue=document.getElementById("score-value"),this.episode=document.getElementById("episode"),this.episodeValue=document.getElementById("episode-value")}updateScore(t){this.scoreValue.textContent=t}updateHighestScore(t){this.highScoreValue.textContent=t}updateEpisode(t){this.episodeValue.textContent=t}showEpisode(){this.episode.style.display=""}hideEpisode(){this.episode.style.display="none"}}class H{constructor(t){_(this,"_keydownControl",t=>{const s=["Tab","Escape","Alt","Control","Shift","Meta"],i=document.activeElement.tagName==="INPUT";this.overlay.style.display!=="none"&&this.overlayScore.style.display==="none"&&!i&&!s.includes(t.key)&&this._onStart()});this.overlay=document.getElementById("overlay"),this.overlayTitle=document.getElementById("overlay-title"),this.overlayScore=document.getElementById("overlay-score"),this.overlayInstruction=document.getElementById("overlay-instruction"),this._onStart=t,document.addEventListener("keydown",this._keydownControl)}show(){this.overlay.style.display="flex"}hide(){this.overlay.style.display="none"}showStart(){this.overlayScore.style.display="none",this.overlayInstruction.style.display="none",this._setText("Press any key to start"),this.overlayTitle.style.fontSize="2.5rem",this.show()}showGameOver(t){this._setText("Game Over"),this.overlayTitle.style.fontSize="3rem",this.overlayScore.textContent=`Score: ${t}`,this.overlayInstruction.textContent="Press any key to reset",this.overlayScore.style.display="block",this.overlayInstruction.style.display="block",this.show()}_setText(t){this.overlayTitle.textContent=t}removeEvent(){document.removeEventListener("keydown",this._keydownControl),this.overlay.style.display="none",this._onStart=null}}class P{constructor({width:t=40,height:s=20,cellSize:i=20,manual:e=!1}={}){this.width=t,this.height=s,this.cellSize=i,this.manual=e,this.highestScore=0,this.board=new z(this.width,this.height,this.cellSize),this.game=new I(this.width,this.height),this.hud=new V,this.overlay=this.manual?new H(this.start.bind(this)):null,this.intervalId=null,this.action=1,this._handleKeydown=this._handleKeydown.bind(this),this.setControlMode(this.manual)}_init(){var t;(t=this.overlay)==null||t.showStart(),this.render()}setControlMode(t){this.manual=t,this.manual?this.hud.hideEpisode():this.hud.showEpisode(),this._init()}start(){var t;this.intervalId&&clearInterval(this.intervalId),(t=this.overlay)==null||t.hide(),this.intervalId=setInterval(()=>{if(this.game.step(this.action),this.game.isDone()){clearInterval(this.intervalId),this.intervalId=null,this._handleGameOver();return}this.render(),this.action=1},100)}step(t){const s=this.game.step(t);return this.render(),s}render(){const t=this.game.snake,s=this.game.food;this.board.render(t.getSegments(),s.getPosition()),this.hud.updateScore(this.game.getScore())}getState(){return this.game.getState()}updateEpisode(t){this.hud.updateEpisode(t)}restartRound(){this.highestScore=Math.max(this.highestScore,this.game.getScore()),this.hud.updateHighestScore(this.highestScore),this.game.reset(),this._init()}attachKeydownListener(){document.addEventListener("keydown",this._handleKeydown)}_handleKeydown(t){function s(e){return["Tab","Alt","Meta","Control","Shift"].includes(e)||e.startsWith("Arrow")}this.intervalId&&s(t.key)&&t.preventDefault();const i={ArrowLeft:0,ArrowUp:1,ArrowRight:2,ArrowDown:3};if(t.key in i){const e=this.game.getDirection();this.action=I.getRelativeAction(e,i[t.key])}}_handleGameOver(){var s;(s=this.overlay)==null||s.showGameOver(this.game.getScore());const t=i=>{["Tab","Alt","Meta","Control","Shift"].includes(i.key)||(i.stopPropagation(),i.preventDefault(),document.removeEventListener("keydown",t),this.restartRound())};document.addEventListener("keydown",t)}removeEvent(){var t,s;this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),(t=this.overlay)==null||t.removeEvent(),(s=this.inputPanel)==null||s.removeEvent()}}function K(r){const t=new P({...r,manual:!0});return t.attachKeydownListener(),{game:t,destroy:()=>{var s;(s=t.removeEvent)==null||s.call(t)}}}const k=[0,1,2];class Q{constructor(t=.1,s=.9,i=1,e=0,n=.995){this.alpha=t,this.gamma=s,this.epsilon=i,this.minEpsilon=e,this.epsilonDecay=n,this.qTable=new Map}getQ(t,s){const i=JSON.stringify([...t,s]),e=this.qTable.get(i);return e||0}updateQ(t,s,i,e){const n=JSON.stringify([...t,s]),o=this.getQ(t,s),l=Math.max(...k.map(d=>this.getQ(e,d))),h=(1-this.alpha)*o+this.alpha*(i+this.gamma*l);this.qTable.set(n,h)}chooseAction(t){if(Math.random()<this.epsilon)return k[Math.floor(Math.random()*k.length)];{const s=k.map(n=>this.getQ(t,n)),i=Math.max(...s),e=k.filter(n=>s[n]===i);return e[Math.floor(Math.random()*e.length)]}}decayEpsilon(){this.epsilon=Math.max(this.minEpsilon,this.epsilon*this.epsilonDecay)}}function $(r){let i=20;const e=new P(r),n=new Q,o=5e3;let l=0,h=!1,d=!1;function y(u){u.keyCode===32&&(i=i===0?20:0)}async function m(){if(l>=o||h){console.log("Training complete!");return}let u=e.getState(),w=0;for(;!e.game.isDone()&&!h;){d&&await new Promise(p=>{const E=()=>{d||(document.removeEventListener("resume-training",E),p())};document.addEventListener("resume-training",E)});const v=n.chooseAction(u),{nextState:S,reward:L}=e.step(v);n.updateQ(u,v,L,S),u=S,i===20?await new Promise(p=>setTimeout(p,i)):++w%200===0?await new Promise(p=>setTimeout(p,i)):await Promise.resolve()}h||(n.decayEpsilon(),e.restartRound(),e.updateEpisode(++l),m())}return document.addEventListener("keydown",y),{game:e,start:()=>{l=0,h=!1,d=!1,m()},pause:()=>{d=!0},resume:()=>{d&&(d=!1,document.dispatchEvent(new Event("resume-training")))},stop:()=>{i=20,h=!0,d=!1,e.updateEpisode(l),console.log("Training stopped.")},speedUp:()=>{i=0},slowDown:()=>{i=20},destroy:()=>{var u;h=!0,document.removeEventListener("keydown",y),(u=e.removeEvent)==null||u.call(e)}}}function W(){const r={width:40,height:20,cellSize:20};let t=null,s=!1;new N({...r,onSizeChange:i});function i(o,l){o==="width"?r.width=l:o==="height"?r.height=l:o==="cellSize"&&(r.cellSize=l),e(s)}function e(o){var l;s=o,(l=t==null?void 0:t.destroy)==null||l.call(t),t=o?$(r):K(r)}const n=R(e);n.onStart(()=>{var o;return(o=t==null?void 0:t.start)==null?void 0:o.call(t)}),n.onPause(()=>{var o;return(o=t==null?void 0:t.pause)==null?void 0:o.call(t)}),n.onResume(()=>{var o;return(o=t==null?void 0:t.resume)==null?void 0:o.call(t)}),n.onStop(()=>{var o;return(o=t==null?void 0:t.stop)==null?void 0:o.call(t)}),n.onSpeedUp(()=>{var o;return(o=t==null?void 0:t.speedUp)==null?void 0:o.call(t)}),n.onSlowDown(()=>{var o;return(o=t==null?void 0:t.slowDown)==null?void 0:o.call(t)})}document.body.style.visibility="hidden";window.addEventListener("load",()=>{document.body.style.visibility="visible"});W();
